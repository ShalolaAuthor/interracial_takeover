bno_find_trainer_for_tribute = {
    save_scope_as = story
    var:scheme = {
        scheme_owner = {
            save_scope_as = scheme_owner
        }
    }
    story_owner = {
        save_scope_as = story_owner
        scope:scheme_owner = {
            bno_hire_trainer_effect = yes
        }
        if = {
            limit = {
                exists = scope:trainer
                scope:trainer = {
                    is_alive = yes
                }
            }
            scope:story = {
                set_variable = {
                    name = bno_trainer
                    value = scope:trainer
                }
            }
            scope:scheme_owner = {
                send_interface_message = {
                    type = bno_blacked_events
                    title = bno_offer_tribute_found_suitable_trainer.title
                    desc = bno_offer_tribute_found_suitable_trainer.desc
                    scope:story_owner = {
                        set_relation_bno_offer_tribute_trainer = scope:trainer
                    }
                }
            }
        }
    }
}

bno_hire_trainer_effect = {
    create_bbc = {
        age = bno_young_adult
        SCOPE_NAME = trainer
    }
    scope:trainer = {
        add_character_flag = bno_offer_tribute.created
    }
    hidden_effect = {
        add_courtier = scope:trainer
    }
}

bno_training_add_scheme_progress = {
    switch = {
        trigger = has_trait
        bno_servile = {
            add_trait_xp = {
	        	trait = bno_servile
	        	value = 1
	        }
        }
        fallback = { add_trait = bno_servile }
    }
	var:story_bno_tribute_training = {
		var:scheme = {
			add_scheme_progress = 1
		}
	}
}

bno_add_training_and_scheme_progress = {
    scope:tribute = {
        switch = {
            trigger = has_trait
            bno_servile = {
                add_trait_xp = {
	            	trait = bno_servile
	            	value = $VALUE$
	            }
            }
            fallback = { add_trait = bno_servile }
        }
    }
    scope:scheme = {
        add_scheme_progress = $VALUE$
    }
}

bno_beauty_training_maxed = {
    if = {
        limit = {
            scope:tribute = {
                has_trait = beauty_good_3
            }
        }
        trigger_event = bno_offer_tribute.1103
    }
}

bno_breast_training_maxed = {
    if = {
        limit = {
            scope:tribute = {
                has_trait = tits_big_good_4
            }
        }
        trigger_event = bno_offer_tribute.1113
    }
}

bno_asses_training_maxed = {
    if = {
        limit = {
            scope:tribute = {
                has_trait = ass_big_good_4
            }
        }
        trigger_event = bno_offer_tribute.1123
    }
}

bno_offer_tribute_final_reward = {
    scope:tribute = {
        every_character_artifact = {
            limit = {
                has_variable = bno_chastity_piercing
            }
            save_scope_as = bno_chastity_piercing
            destroy_artifact = scope:bno_chastity_piercing
        }
        create_character_memory = {
            type = bno_offer_tribute_$TYPE$
            participants = {
                target = scope:target
                scheme_owner = scope:owner
                trainer = scope:trainer
            }
        }
        if = {
            limit = { scope:scheme.var:offer_tribute_end_goal = flag:lending }
            add_character_modifier = {
                modifier = bno_offer_tribute_result_$TYPE$
                years = 5
            }
        }
        else = {
            add_character_modifier = bno_offer_tribute_result_$TYPE$
        }
        remove_variable = story_bno_tribute_training
        #TODO: for now is_ruler no is a bandaid fix for this scheme, next time i should do is_ruler yes, then i will do an event to strip her title
    }
    scope:target = {
        pay_short_term_gold = {
            gold = $REWARD$
            target = scope:trainer
        }
    }
    scope:trainer = {
        add_prestige = {
            value = $REWARD$
            divide = 2
        }
        add_piety = {
            value = $REWARD$
            divide = 5
        }
    }
    if = {
        limit = {
            owns_story_of_type = story_bno_offer_tribute_rewards
        }
        var:story_bno_offer_tribute_rewards = {
            add_to_variable_list = {
                name = bno_patrons
                target = scope:owner
            }
            add_to_variable_list = {
                name = bno_tributes
                target = scope:tribute
            }
        }
    }
    else = {
        create_story = {
            type = story_bno_offer_tribute_rewards
            save_scope_as = story_bno_offer_tribute_rewards
        }
        set_variable = {
            name = story_bno_offer_tribute_rewards
            value = scope:story_bno_offer_tribute_rewards
        }
        scope:story_bno_offer_tribute_rewards = {
            add_to_variable_list = {
                name = bno_patrons
                target = scope:owner
            }
            add_to_variable_list = {
                name = bno_tributes
                target = scope:tribute
            }
        }
    }

    add_courtier = scope:tribute
    set_relation_bno_slave = scope:tribute
    if = {
        limit = {
            scope:scheme.var:offer_tribute_end_goal = flag:lending
        }
        scope:tribute = {
            create_story = {
                type = story_bno_offer_tribute_lending
                save_scope_as = story_bno_offer_tribute_lending
            }
            set_variable = {
                name = story_bno_offer_tribute_lending
                value = scope:story_bno_offer_tribute_lending
            }
            scope:story_bno_offer_tribute_lending = {
                set_variable = {
                    name = bno_offer_tribute_target
                    value = scope:target
                }
                set_variable = {
                    name = bno_offer_tribute_owner
                    value = scope:owner
                }
            }
        }
    }
}

bno_trainer_final_travel_home = {
    scope:trainer = {
        create_story = {
            type = story_bno_tribute_trainer_journey
            save_scope_as = story_bno_tribute_trainer_journey
        }
        set_variable = {
            name = story_bno_tribute_trainer_journey
            value = scope:story_bno_tribute_trainer_journey
        }
        set_variable = {
            name = offer_tribute_scheme
            value = scope:scheme
        }
        start_travel_plan = {
            destination = scope:owner.capital_province
            travel_with_domicile = yes
            players_use_planner = no                
            return_trip = no
            can_cancel_planning = no
            on_arrival_on_action = bno_offer_tribute_travel_plan_trainer_arrived_back_to_scheme_owner
            on_arrival_destinations = last
        }
    }
}

bno_target_gain_gold_from_every_adult_black_people = {
    #needs character scope here
    save_scope_as = bno_target_gain_gold_from_every_adult_black_people_scope
    set_variable = {
        name = bno_gold_now
        value = gold
        months = 1
    }
    every_in_global_list = {
        variable = bno_black_people_list
        limit = {
            is_alive = yes
            is_adult = yes
            gold > 1
        }
        hidden_effect = {
            pay_short_term_gold = {
                gold = { 0 1 }
                target = scope:bno_target_gain_gold_from_every_adult_black_people_scope
            }
        }
    }
    set_variable = {
        name = bno_gold_after
        value = gold
        months = 1
    }
    custom_description = {
        text = bno_target_gains_gold_in_anticipation_of_tribute_coming
        value = bno_target_gold_from_solidarity
    }
}

bno_remove_from_tributes_and_patrons_list = {
    var:bno_offer_tribute_target = {
        save_scope_as = target
    }
    var:bno_offer_tribute_owner = {
        save_scope_as = owner
    }
    story_owner = {
        save_scope_as = tribute
        scope:target = {
            remove_list_variable = {
                name = bno_tributes
                target = scope:tribute
            }
            remove_list_variable = {
                name = bno_patrons
                target = scope:owner
            }
        }
    }
}

bno_return_tribute_to_parent = {
    bno_remove_from_tributes_and_patrons_list = yes
    story_owner = {
        remove_relation_bno_slave = scope:target
        scope:target = {
            remove_courtier_or_guest = scope:tribute
        }
        if = {
            limit = {
                any_parent = {
                    is_alive = yes
                    OR = {
                        is_ruler = yes
                        any_spouse = {
                            is_ruler = yes
                        }
                    }
                }
            }
            random_parent = {
                limit = {
                    is_alive = yes
                    OR = {
                        is_ruler = yes
                        any_spouse = {
                            is_ruler = yes
                        }
                    }
                }
                save_scope_as = parent
            }
            scope:target = {
                save_scope_as = bno_target
            }
            start_travel_plan = {
                destination = scope:parent.location
                travel_leader = scope:tribute
                travel_with_domicile = yes
                players_use_planner = no
                return_trip = no
                can_cancel_planning = no
                on_start_on_action = bno_offer_tribute_after_lending_start
                on_arrival_on_action = bno_offer_tribute_after_lending_arrival
                on_arrival_destinations = last
            }
        }
    }
    end_story = yes
}