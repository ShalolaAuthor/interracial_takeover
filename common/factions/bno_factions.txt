@base_bnwo_discontent_progress = 5

bnwo_faction = {
    casus_belli = bno_civil_unrest

    short_effect_desc = bnwo_faction.short_effect_desc

    sort_order = 999

    leaders_allowed_to_leave = no
    player_can_join = no
    power_threshold = 0

    discontent_progress = {
        base = @base_bnwo_discontent_progress
        common_discontent_progress_modifier = yes
        modifier = {
            add = {
                value = 0
                if = {
                    limit = {
                        faction_target = {
                            any_realm_county = {
                                OR = {
                                    has_county_modifier = bno_local_bbc_unsatisfied
                                    has_county_modifier = bno_siding_with_local
                                    has_county_modifier = bno_bbc_angered
                                    has_county_modifier = bno_reject_sending_courtier_to_bbc
                                    has_county_modifier = bno_disapprove_daughter_marriage_with_bbc
                                }
                            }
                        }
                    }
                    faction_target = {
                        every_realm_county = {
                            limit = {
                                has_county_modifier = bno_local_bbc_unsatisfied
                            }
                            add = 2
                        }
                        every_realm_county = {
                            limit = {
                                has_county_modifier = bno_siding_with_local
                            }
                            add = 2
                        }
                        every_realm_county = {
                            limit = {
                                has_county_modifier = bno_bbc_angered
                            }
                            add = 2
                        }
                        every_realm_county = {
                            limit = {
                                has_county_modifier = bno_reject_sending_courtier_to_bbc
                            }
                            add = 2
                        }
                        every_realm_county = {
                            limit = {
                                has_county_modifier = bno_disapprove_daughter_marriage_with_bbc
                            }
                            add = 2
                        }
                    }
                }
            }
            faction_target = {
                any_realm_county = {
                    OR = {
                        has_county_modifier = bno_local_bbc_unsatisfied
                        has_county_modifier = bno_siding_with_local
                        has_county_modifier = bno_bbc_angered
                        has_county_modifier = bno_reject_sending_courtier_to_bbc
                        has_county_modifier = bno_disapprove_daughter_marriage_with_bbc
                    }
                }
            }
        }
    }

    name = bnwo_faction.name    

    requires_county = yes
    requires_character = no

    #Faction existence is valid
    is_valid = {
        always = yes
    }

    #county valid check
    is_county_valid = {
        OR = {
            has_county_modifier = bno_local_bbc_unsatisfied
            has_county_modifier = bno_siding_with_local
            has_county_modifier = bno_bbc_angered
            has_county_modifier = bno_reject_sending_courtier_to_bbc
            has_county_modifier = bno_disapprove_daughter_marriage_with_bbc
        }
    }

    #character valid check
    is_character_valid = {
        is_culture_bnoc = yes
        faith = {
            is_considered_bno_faith = yes
        }
    }

    demand = {
        save_scope_as = faction
        setup_bnwo_leader_effect = yes
        faction_leader = {
            add_opinion = {
                modifier = angry_opinion
                target = root.faction_target
                opinion = -100
            }
        }
        get_bnwo_revolt_target_effect = { FACTION = this }
        special_character = {
            save_scope_as = peasant_leader
        }
        special_title = {
            save_scope_as = target_title
        }

        save_temporary_scope_as = county_faction
        every_faction_county_member = {
            limit = {
                holder = {
                    NOT = { this = scope:faction.faction_target }
                    NAND = {
                        exists = joined_faction
                        joined_faction = {
                            this = scope:county_faction
                        }
                    }
                    is_vassal_of = scope:faction.faction_target
                }
            }
            holder = {
                add_to_list = bnwo_faction_vassal_targets
            }
        }
        every_faction_county_member = {
            holder = {
                every_liege_or_above = {
                    limit = {
                        NOT = { this = scope:faction.faction_target }
                        NAND = {
							exists = joined_faction
							joined_faction = {
								this = scope:county_faction
							}
						}
						is_vassal_of = scope:faction.faction_target
                        NOT = { is_in_list = bnwo_faction_vassal_targets }
                    }
                    add_to_list = bnwo_faction_vassal_targets
                }
            }
        }

        if = {
            limit = {
                any_in_list = {
                    list = bnwo_faction_vassal_targets
                    is_ai = no
                }
            }
            scope:faction = {
                set_variable = {
                    name = faction_targets_player
                    value = yes
                }
            }
        }
        #launch the demand event
        scope:faction.faction_target = {
            trigger_event = bno_embrace_african_1.0007
        }
    }

    can_character_join = {
        OR = {
            is_african = yes
            is_bbc = yes
            is_bno_mindless_bbc_slut = yes
        }
        is_culture_bnoc = yes
        faith = {
            is_considered_bno_faith = yes
        }
    }

    can_county_join = {
        OR = {
            has_county_modifier = bno_local_bbc_unsatisfied
            has_county_modifier = bno_siding_with_local
            has_county_modifier = bno_bbc_angered
            has_county_modifier = bno_reject_sending_courtier_to_bbc
            has_county_modifier = bno_disapprove_daughter_marriage_with_bbc
        }
    }

    can_county_create = {
        county_opinion < 0

        has_county_modifier = bno_local_bbc_unsatisfied
    }

    can_character_become_leader = {
        has_trait = bno_bbc
    }

    county_create_score = {
        base = 0
        modifier = {
            add = -100
            has_county_modifier = bno_might_makes_right
        }
        modifier = {
            add = 100
            has_county_modifier = bno_local_bbc_unsatisfied
        }
        modifier = {
            add = -50
            holder = {
                OR = {
                    has_trait = bno_bbc
                    has_trait = bno_whitegirl
                }
            }
        }
        modifier = {
            add = 50
            holder = {
                has_trait = bno_whiteboi
            }
        }
    }

    county_join_score = {
        base = 0
        modifier = {
            add = -100
            has_county_modifier = bno_might_makes_right
        }
        modifier = {
            add = 100
            has_county_modifier = bno_local_bbc_unsatisfied
        }
        modifier = {
            add = -50
            holder = {
                OR = {
                    has_trait = bno_bbc
                    has_trait = bno_whitegirl
                }
            }
        }
        modifier = {
            add = 50
            holder = {
                has_trait = bno_whiteboi
            }
        }
    }

    county_power = county_levies_to_raise

    ai_join_score = {
        base = 0

        modifier = {
            add = -100
            is_playable_character = yes
        }

        modifier = {
            add = 100
            has_trait = bno_bbc
        }
        modifier = {
            add = 100
            has_trait = bno_camp_leader
        }
    }

    on_creation = {
        random_faction_county_member = {
            save_scope_as = founding_county
        }
    }

    on_destroy = {
        set_variable = {
            name = peasant_destroying
            value = yes
        }
        if = {
            limit = { exists = special_character }
            special_character = {
                if = {
                    limit = { has_variable = peasant_title }
                    destroy_title = this.var:peasant_title
                }
                if = {
                    limit = {
                        is_alive = yes
                    }
                    remove_character_flag = bnwo_faction_claimant_without_title
                    remove_variable = peasant_title
                    remove_variable = bnwo_leader_peasants
                    if = {
                        limit = {
                            has_character_flag = spawned_in_bnwo_faction_leader
                        }
                        death = {
                            death_reason = death_vanished
                        }
                    }
                }
            }
        }
    }


    ai_demand_chance = {
        base = 100

        modifier = {
			add = -1000
			faction_target = {
				involved_activity ?= {
					has_activity_type = activity_coronation
					activity_host = prev
				}
			}
		}
    }

    on_war_start = {
        every_faction_county_member = {
            duchy = {
                add_to_list = areas_of_rebellion
            }
        }

        every_in_list = {
            list = areas_of_rebellion
            save_temporary_scope_as = this_duchy
            ordered_in_de_jure_hierarchy = {
                limit = {
                    tier = tier_county
                    any_title_joined_faction = {
                        this = root
                    }
                }

                order_by = total_county_levies

                title_province = {
                    save_temporary_scope_as = local_center_of_rebellion
                }
            }

            root.faction_leader = {
                spawn_bnwo_revolt_troops = yes
            }

            #give populist leader a commander
            create_character = {
                template = bbc_noble_template
                location = scope:local_center_of_rebellion
                save_scope_as = new_bnwo_commander
            }
            scope:new_bnwo_commander = {
                set_employer = root.faction_leader
            }
        }

        #give gold to leader
        every_faction_county_member = {
            root.faction_leader = {
                add_gold = {
                    value = minor_gold_value
                    add = 25
                }
            }
        }
    }

    leader_leaves = {
        #only trigger when leader got captured
        if = {
            limit = {
                special_character = {
                    is_alive = no
                }
            }
            faction_war = {
                end_war = defender
            }
            destroy_faction = yes
        }
        if = {
            limit = {
                NOT = { has_variable = peasant_destroying }
                exists = faction_war
            }
            faction_war = {
                end_war = defender
            }
        }
    }

    character_allow_create = no

    special_character_title = bnwo_faction_leader_title

    inherit_membership = yes

    multiple_targeting = yes
}